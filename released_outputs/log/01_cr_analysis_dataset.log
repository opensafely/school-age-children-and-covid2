-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /workspace/log/01_cr_analysis_dataset.log
  log type:  text
 opened on:  23 Jan 2021, 00:06:46

. 
. 
. *Import dataset into STATA
. import delimited "output/`inputfile'", clear
(57 vars, 23,349,395 obs)

. 
. /* CONVERT STRINGS TO DATE===================================================
> =*/
. /* Comorb dates and TPP case outcome dates are given with month only, so addi
> ng day 
> 15 to enable  them to be processed as dates                                  
>                                                      */
. 
. *cr date for diabetes based on adjudicated type
. gen diabetes=type1_diabetes if diabetes_type=="T1DM"
(23,244,685 missing values generated)

. replace diabetes=type2_diabetes if diabetes_type=="T2DM"
(1,291,166 real changes made)

. replace diabetes=unknown_diabetes if diabetes_type=="UNKNOWN_DM"
(416,399 real changes made)

. 
. drop type1_diabetes type2_diabetes unknown_diabetes

. 
. foreach var of varlist  chronic_respiratory_disease ///
>                                                 chronic_cardiac_disease  ///
>                                                 diabetes ///
>                                                 cancer_haem  ///
>                                                 cancer_nonhaem  ///
>                                                 permanent_immunodeficiency  /
> //
>                                                 temporary_immunodeficiency  /
> //
>                                                 dialysis                     
>                    ///
>                                                 kidney_transplant            
>            ///
>                                                 other_transplant             
>            /// 
>                                                 asplenia                     
>    /// 
>                                                 chronic_liver_disease  ///
>                                                 other_neuro  ///
>                                                 stroke_dementia              
>            ///
>                                                 esrf  ///
>                                                 hypertension  ///
>                                                 ra_sle_psoriasis  ///
>                                                 bmi_date_measured   ///
>                                                 bp_sys_date_measured   ///
>                                                 bp_dias_date_measured   ///
>                                                 creatinine_date  ///
>                                                 smoking_status_date ///
>                                                 dereg_date ///
>                                                 {
  2.                                                         
.                 capture confirm string variable `var'
  3.                 if _rc!=0 {
  4.                         assert `var'==.
  5.                         rename `var' `var'_date
  6.                 }
  7.         
.                 else {
  8.                                 replace `var' = `var' + "-15"
  9.                                 rename `var' `var'_dstr
 10.                                 replace `var'_dstr = " " if `var'_dstr == 
> "-15"
 11.                                 gen `var'_date = date(`var'_dstr, "YMD") 
 12.                                 order `var'_date, after(`var'_dstr)
 13.                                 drop `var'_dstr
 14.                 }
 15.         
.         format `var'_date %td
 16. }
variable chronic_respiratory_disease was str7 now str10
(23,349,395 real changes made)
(22,561,679 real changes made)
(22,561,679 missing values generated)
variable chronic_cardiac_disease was str7 now str10
(23,349,395 real changes made)
(22,018,224 real changes made)
(22,018,224 missing values generated)
variable diabetes was str7 now str10
(23,349,395 real changes made)
(21,537,120 real changes made)
(21,537,120 missing values generated)
variable cancer_haem was str7 now str10
(23,349,395 real changes made)
(23,232,258 real changes made)
(23,232,258 missing values generated)
variable cancer_nonhaem was str7 now str10
(23,349,395 real changes made)
(22,372,322 real changes made)
(22,372,322 missing values generated)
variable permanent_immunodeficiency was str7 now str10
(23,349,395 real changes made)
(23,295,556 real changes made)
(23,295,556 missing values generated)
variable temporary_immunodeficiency was str7 now str10
(23,349,395 real changes made)
(23,343,788 real changes made)
(23,343,788 missing values generated)
variable dialysis was str7 now str10
(23,349,395 real changes made)
(23,326,239 real changes made)
(23,326,239 missing values generated)
variable kidney_transplant was str7 now str10
(23,349,395 real changes made)
(23,333,691 real changes made)
(23,333,691 missing values generated)
variable other_transplant was str7 now str10
(23,349,395 real changes made)
(23,344,498 real changes made)
(23,344,498 missing values generated)
variable asplenia was str7 now str10
(23,349,395 real changes made)
(23,321,919 real changes made)
(23,321,919 missing values generated)
variable chronic_liver_disease was str7 now str10
(23,349,395 real changes made)
(23,231,362 real changes made)
(23,231,362 missing values generated)
variable other_neuro was str7 now str10
(23,349,395 real changes made)
(23,147,912 real changes made)
(23,147,912 missing values generated)
variable stroke_dementia was str7 now str10
(23,349,395 real changes made)
(22,889,786 real changes made)
(22,889,786 missing values generated)
variable esrf was str7 now str10
(23,349,395 real changes made)
(23,321,018 real changes made)
(23,321,018 missing values generated)
variable hypertension was str7 now str10
(23,349,395 real changes made)
(19,385,469 real changes made)
(19,385,469 missing values generated)
variable ra_sle_psoriasis was str7 now str10
(23,349,395 real changes made)
(22,377,470 real changes made)
(22,377,470 missing values generated)
variable bmi_date_measured was str7 now str10
(23,349,395 real changes made)
(8,216,694 real changes made)
(8,216,694 missing values generated)
variable bp_sys_date_measured was str7 now str10
(23,349,395 real changes made)
(6,128,669 real changes made)
(6,128,669 missing values generated)
variable bp_dias_date_measured was str7 now str10
(23,349,395 real changes made)
(6,132,143 real changes made)
(6,132,143 missing values generated)
variable creatinine_date was str7 now str10
(23,349,395 real changes made)
(8,939,813 real changes made)
(8,939,813 missing values generated)
variable smoking_status_date was str7 now str10
(23,349,395 real changes made)
(4,731,084 real changes made)
(4,731,084 missing values generated)
variable dereg_date was str7 now str10
(23,349,395 real changes made)
(0 real changes made)

. 
. * Recode to dates from the strings 
. foreach var of varlist covid_icu_date positive_covid_test       died_date_ons
>  covid_admission_date covid_tpp_probable   {
  2.                                                 
.         confirm string variable `var'
  3.         rename `var' `var'_dstr
  4.         gen `var' = date(`var'_dstr, "YMD")
  5.         drop `var'_dstr
  6.         format `var' %td 
  7.         
. }
(23,340,990 missing values generated)
(22,451,150 missing values generated)
(23,146,640 missing values generated)
(23,289,742 missing values generated)
(22,880,761 missing values generated)

. 
. gen covid_admission_primary_date = covid_admission_date ///
> if (covid_admission_primary_diagnosi == "U071"| covid_admission_primary_diagn
> osi == "U072")
(23,312,523 missing values generated)

. 
. gen  covid_primary_care_codes_only=covid_tpp_probable
(22,880,761 missing values generated)

. format covid_primary_care_codes_only %td

. replace covid_tpp_probable=positive_covid_test_ever if covid_tpp_probable==. 
> & covid_tpp_probable>positive_covid_test
(484,520 real changes made)

. 
. 
. /*Tab all variables in initial extract*/
. sum, d f

                         patient_id
-------------------------------------------------------------
      Percentiles      Smallest
 1%       433197           2878
 5%      2049909           7276
10%      4198472           9969       Obs          23,349,395
25%     1.05e+07           9970       Sum of Wgt.    23349395

50%     2.18e+07                      Mean           2.32e+07
                        Largest       Std. Dev.      1.47e+07
75%     3.49e+07       5.45e+07
90%     4.51e+07       5.45e+07       Variance       2.17e+14
95%     4.87e+07       5.45e+07       Skewness        .256626
99%     5.15e+07       5.45e+07       Kurtosis       1.934977

                       dereg_date_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jun2020      15feb2020
 5%    15dec9999      15feb2020
10%    15dec9999      15feb2020       Obs          23,349,395
25%    15dec9999      15feb2020       Sum of Wgt.    23349395

50%    15dec9999                      Mean          14aug9752
                        Largest       Std. Dev.      505090.5
75%    15dec9999      15dec9999
90%    15dec9999      15dec9999       Variance       2.55e+11
95%    15dec9999      15dec9999       Skewness      -5.412363
99%    15dec9999      15dec9999       Kurtosis       30.29367

                     has_12_m_follow_up
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            1              0       Obs          23,349,395
25%            1              0       Sum of Wgt.    23349395

50%            1                      Mean           .9367157
                        Largest       Std. Dev.      .2434736
75%            1              1
90%            1              1       Variance       .0592794
95%            1              1       Skewness      -3.587376
99%            1              1       Kurtosis       13.86927

                   died_ons_covid_flag_any
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs          23,349,395
25%            0              0       Sum of Wgt.    23349395

50%            0                      Mean           .0013221
                        Largest       Std. Dev.      .0363371
75%            0              1
90%            0              1       Variance       .0013204
95%            0              1       Skewness       27.44731
99%            0              1       Kurtosis        754.355

               died_ons_covid_flag_underlying
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs          23,349,395
25%            0              0       Sum of Wgt.    23349395

50%            0                      Mean           .0011882
                        Largest       Std. Dev.      .0344499
75%            0              1
90%            0              1       Variance       .0011868
95%            0              1       Skewness       28.95864
99%            0              1       Kurtosis       839.6028

              covid_admission_primary_diagnosis
-------------------------------------------------------------
no observations

                             age
-------------------------------------------------------------
      Percentiles      Smallest
 1%            1              0
 5%            5              0
10%            9              0       Obs          23,349,395
25%           22              0       Sum of Wgt.    23349395

50%           40                      Mean           41.05426
                        Largest       Std. Dev.      23.41772
75%           59            119
90%           73            120       Variance       548.3896
95%           80            120       Skewness       .1094533
99%           89            121       Kurtosis       2.059853

                             sex
-------------------------------------------------------------
no observations

                             imd
-------------------------------------------------------------
      Percentiles      Smallest
 1%           -1             -1
 5%         1000             -1
10%         2500             -1       Obs          23,349,395
25%         7500             -1       Sum of Wgt.    23349395

50%        15800                      Mean            15788.6
                        Largest       Std. Dev.      9528.532
75%        23900          32800
90%        29000          32800       Variance       9.08e+07
95%        30900          32800       Skewness       .0174403
99%        32400          32800       Kurtosis       1.818861

                             stp
-------------------------------------------------------------
no observations

                          ethnicity
-------------------------------------------------------------
      Percentiles      Smallest
 1%            1              1
 5%            1              1
10%            1              1       Obs          17,068,744
25%            1              1       Sum of Wgt.    17068744

50%            1                      Mean           1.379429
                        Largest       Std. Dev.       .946791
75%            1              5
90%            3              5       Variance       .8964132
95%            4              5       Skewness       2.472757
99%            5              5       Kurtosis       8.129274

                       ethnicity_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%         2004           1888
 5%         2007           1899
10%         2008           1899       Obs          17,068,744
25%         2010           1899       Sum of Wgt.    17068744

50%         2014                      Mean           2013.109
                        Largest       Std. Dev.      8.134005
75%         2017           2066
90%         2019           2075       Variance       66.16204
95%         2020           2081       Skewness      -10.03603
99%         2020           2095       Kurtosis       138.5624

                        household_id
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs          23,349,395
25%      1358904              0       Sum of Wgt.    23349395

50%      4113313                      Mean            4200714
                        Largest       Std. Dev.       3054443
75%      6824945        9739275
90%      8538838        9739275       Variance       9.33e+12
95%      9149474        9739276       Skewness       .1266538
99%      9625187        9739276       Kurtosis       1.739116

                       household_size
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs          23,349,395
25%            1              0       Sum of Wgt.    23349395

50%            2                      Mean           4.780261
                        Largest       Std. Dev.      45.66067
75%            4           2589
90%            5           2589       Variance       2084.897
95%            7           2589       Skewness       33.96016
99%           13           2589       Kurtosis       1454.208

                       care_home_type
-------------------------------------------------------------
no observations

                             bmi
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0        -3460.2
 5%            0         -277.8
10%            0           -2.1       Obs          23,349,395
25%            0           -1.8       Sum of Wgt.    23349395

50%         22.8                      Mean            58.3321
                        Largest       Std. Dev.      7993.814
75%         28.1        1520000
90%           33        1805556       Variance       6.39e+07
95%         36.6       1.95e+07       Skewness       2571.442
99%         44.9       2.85e+07       Kurtosis        8428052

                   bmi_date_measured_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15aug2010      15feb2010
 5%    15jun2012      15feb2010
10%    15dec2013      15feb2010       Obs          15,132,701
25%    15aug2016      15feb2010       Sum of Wgt.    15132701

50%    15dec2018                      Mean          23jan2018
                        Largest       Std. Dev.       1828.13
75%    15jan2020      15mar9909
90%    15sep2020      15apr9909       Variance        3342059
95%    15nov2020      15apr9912       Skewness       1104.787
99%    15dec2020      15jul9935       Kurtosis        1705394

                           bp_sys
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0             -1
 5%            0             -1
10%            0             -1       Obs          23,349,395
25%            0             -1       Sum of Wgt.    23349395

50%          120                      Mean           93.29804
                        Largest       Std. Dev.      116.4923
75%          132         136136
90%          142         137137       Variance       13570.46
95%          149         139139       Skewness       771.0692
99%          167         139139       Kurtosis       827448.7

                  bp_sys_date_measured_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15oct2003      15jan1860
 5%    15dec2010      15jan1860
10%    15jan2014      15dec1899       Obs          17,220,726
25%    15mar2017      15dec1899       Sum of Wgt.    17220726

50%    15feb2019                      Mean          14oct2017
                        Largest       Std. Dev.      1273.019
75%    15sep2019      15feb2020
90%    15dec2019      15feb2020       Variance        1620577
95%    15jan2020      15feb2020       Skewness      -5.003394
99%    15jan2020      15feb2020       Kurtosis       90.62341

                           bp_dias
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0             -1
 5%            0             -1
10%            0             -1       Obs          23,349,395
25%            0             -1       Sum of Wgt.    23349395

50%           70                      Mean           56.10533
                        Largest       Std. Dev.      39.60653
75%           80           8368
90%           87           9074       Variance       1568.677
95%           90          10878       Skewness       491.0354
99%          100          89147       Kurtosis        1097353

                 bp_dias_date_measured_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15oct2003      15jan1860
 5%    15jan2011      15jan1860
10%    15jan2014      15dec1899       Obs          17,217,252
25%    15mar2017      15dec1899       Sum of Wgt.    17217252

50%    15feb2019                      Mean          15oct2017
                        Largest       Std. Dev.      1250.839
75%    15sep2019      15feb2020
90%    15dec2019      15feb2020       Variance        1564598
95%    15jan2020      15feb2020       Skewness      -4.058826
99%    15jan2020      15feb2020       Kurtosis       55.43585

                         creatinine
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0            -40
 5%            0             -1
10%            0             -1       Obs          23,349,395
25%            0             -1       Sum of Wgt.    23349395

50%           60                      Mean           1349.323
                        Largest       Std. Dev.      328346.4
75%           77       1.19e+08
90%           92       1.20e+08       Variance       1.08e+11
95%          101       1.21e+08       Skewness       264.9897
99%          129       1.58e+08       Kurtosis       72939.63

                    creatinine_date_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan2005      15dec1899
 5%    15dec2010      15dec1899
10%    15aug2013      15dec1899       Obs          14,409,582
25%    15jan2017      15jan1900       Sum of Wgt.    14409582

50%    15jan2019                      Mean          21sep2017
                        Largest       Std. Dev.      1178.017
75%    15sep2019      15feb2020
90%    15dec2019      15feb2020       Variance        1387723
95%    15jan2020      15feb2020       Skewness      -3.713264
99%    15jan2020      15feb2020       Kurtosis       61.98723

                       smoking_status
-------------------------------------------------------------
no observations

                  smoking_status_date_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan2005      15sep1899
 5%    15mar2010      15sep1899
10%    15aug2012      15sep1899       Obs          18,618,311
25%    15oct2015      15sep1899       Sum of Wgt.    18618311

50%    15jul2018                      Mean          17feb2017
                        Largest       Std. Dev.      1322.228
75%    15jul2019      15feb2020
90%    15nov2019      15feb2020       Variance        1748287
95%    15dec2019      15feb2020       Skewness      -4.717992
99%    15jan2020      15feb2020       Kurtosis       98.60141

              chronic_respiratory_disease_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1800
 5%    15jan1992      15jan1860
10%    15oct2001      15dec1899       Obs             787,716
25%    15jan2008      15dec1899       Sum of Wgt.     787,716

50%    15jun2013                      Mean          31jul2009
                        Largest       Std. Dev.      6347.366
75%    15jun2017      15jan2021
90%    15jun2019      15jan2021       Variance       4.03e+07
95%    15jan2020      15jan2021       Skewness      -4.838159
99%    15nov2020      15jan2021       Kurtosis       29.53223

                chronic_cardiac_disease_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1840
 5%    15jan1987      15dec1840
10%    15jan1995      15jan1850       Obs           1,331,171
25%    15dec2003      15jan1850       Sum of Wgt.   1,331,171

50%    15sep2011                      Mean          27may2007
                        Largest       Std. Dev.      6543.891
75%    15jan2017      15jan2021
90%    15jun2019      15jan2021       Variance       4.28e+07
95%    15feb2020      15jan2021       Skewness      -4.268233
99%    15nov2020      15jan2021       Kurtosis       25.17047

                        diabetes_type
-------------------------------------------------------------
no observations

                     diabetes_exeter_os
-------------------------------------------------------------
no observations

                       diabetes_exeter
-------------------------------------------------------------
no observations

                     hba1c_mmol_per_mol
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0           -782
 5%            0             -2
10%            0             -1       Obs          23,349,395
25%            0             -1       Sum of Wgt.    23349395

50%            0                      Mean           18.06018
                        Largest       Std. Dev.      1811.557
75%           37         107000
90%           42         111000       Variance        3281739
95%           47         759550       Skewness       4727.498
99%           73        8688000       Kurtosis       2.27e+07

                   hba1c_mmol_per_mol_date
-------------------------------------------------------------
no observations

                      hba1c_percentage
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0             -2
 5%            0             -1
10%            0             -1       Obs          23,349,395
25%            0             -1       Sum of Wgt.    23349395

50%            0                      Mean           1.541291
                        Largest       Std. Dev.       3960.18
75%            0            935
90%          5.1         231855       Variance       1.57e+07
95%          5.7         930709       Skewness       4814.485
99%          7.6       1.91e+07       Kurtosis       2.32e+07

                    hba1c_percentage_date
-------------------------------------------------------------
no observations

                      cancer_haem_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1840
 5%    15jul1986      15jan1860
10%    15jan1995      15dec1899       Obs             117,137
25%    15oct2005      15dec1899       Sum of Wgt.     117,137

50%    15jun2013                      Mean          03feb2009
                        Largest       Std. Dev.      5728.594
75%    15nov2017      15jan2021
90%    15oct2019      15jan2021       Variance       3.28e+07
95%    15may2020      15jan2021       Skewness      -4.341538
99%    15nov2020      15jan2021       Kurtosis        28.7974

                     cancer_nonhaem_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1971      15dec1840
 5%    15may1991      15jan1860
10%    15jan1998      15jan1860       Obs             977,073
25%    15may2006      15jan1860       Sum of Wgt.     977,073

50%    15may2013                      Mean          07mar2010
                        Largest       Std. Dev.      4640.008
75%    15nov2017      15jan2021
90%    15nov2019      15jan2021       Variance       2.15e+07
95%    15jun2020      15nov2021       Skewness      -4.547416
99%    15nov2020      15dec2100       Kurtosis       36.35317

               permanent_immunodeficiency_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1900
 5%    15jun1993      15jan1900
10%    15apr2000      15jan1900       Obs              53,839
25%    15jun2007      15jan1900       Sum of Wgt.      53,839

50%    15mar2013                      Mean          15jun2009
                        Largest       Std. Dev.      6098.723
75%    15mar2017      15jan2020
90%    15jan2019      15jan2020       Variance       3.72e+07
95%    15aug2019      15jan2020       Skewness       -5.14979
99%    15dec2019      15jan2020       Kurtosis       33.37928

                        asplenia_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15dec1899
 5%    15oct1956      15dec1899
10%    15jan1967      15dec1899       Obs              27,476
25%    15jan1981      15dec1899       Sum of Wgt.      27,476

50%    15aug1999                      Mean          03sep1993
                        Largest       Std. Dev.      9111.842
75%    15jul2012      15jan2021
90%    15apr2018      15jan2021       Variance       8.30e+07
95%    15sep2019      15jan2021       Skewness      -1.770279
99%    15oct2020      15jan2021       Kurtosis       7.207089

               temporary_immunodeficiency_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15feb2019      15feb2019
 5%    15feb2019      15feb2019
10%    15mar2019      15feb2019       Obs               5,607
25%    15jun2019      15feb2019       Sum of Wgt.       5,607

50%    15sep2019                      Mean          30aug2019
                        Largest       Std. Dev.      102.4461
75%    15nov2019      15jan2020
90%    15jan2020      15jan2020       Variance       10495.21
95%    15jan2020      15jan2020       Skewness      -.4038346
99%    15jan2020      15jan2020       Kurtosis       2.042161

                 chronic_liver_disease_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15dec1840
 5%    15jun1992      15jan1860
10%    15jan2000      15dec1899       Obs             118,033
25%    15dec2007      15dec1899       Sum of Wgt.     118,033

50%    15sep2014                      Mean          25feb2010
                        Largest       Std. Dev.      6331.032
75%    15may2018      15jan2021
90%    15nov2019      15jan2021       Variance       4.01e+07
95%    15jun2020      15jan2021       Skewness      -4.936582
99%    15nov2020      15oct2021       Kurtosis       31.01284

                    stroke_dementia_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1899
 5%    15jan1995      15dec1899
10%    15jan2001      15dec1899       Obs             459,609
25%    15jun2008      15dec1899       Sum of Wgt.     459,609

50%    15sep2014                      Mean          08jan2011
                        Largest       Std. Dev.      5472.734
75%    15may2018      15jan2021
90%    15dec2019      15jan2021       Variance       3.00e+07
95%    15jun2020      15dec2021       Skewness      -5.452798
99%    15nov2020      15jul2096       Kurtosis       39.56342

                      other_neuro_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1800
 5%    15may1965      15jan1800
10%    15sep1980      15jan1860       Obs             201,483
25%    15jan1998      15dec1899       Sum of Wgt.     201,483

50%    15sep2009                      Mean          17nov2002
                        Largest       Std. Dev.      8106.967
75%    15jun2016      15jan2021
90%    15mar2019      15jan2021       Variance       6.57e+07
95%    15jan2020      15jan2021       Skewness      -2.879243
99%    15oct2020      15jan2021       Kurtosis       12.96143

                          esrf_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15dec1899
 5%    15jan1987      15dec1899
10%    15jan1996      15dec1899       Obs              28,377
25%    15jun2006      15dec1899       Sum of Wgt.      28,377

50%    15mar2014                      Mean          29dec2008
                        Largest       Std. Dev.      6757.155
75%    15may2018      15jan2021
90%    15dec2019      15jan2021       Variance       4.57e+07
95%    15jun2020      15jan2021       Skewness       -4.38463
99%    15nov2020      15jan2021       Kurtosis       25.43709

                        dialysis_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15dec1899
 5%    15jul1990      15dec1899
10%    15sep1998      15dec1899       Obs              23,156
25%    15sep2007      15dec1899       Sum of Wgt.      23,156

50%    15jan2015                      Mean          10feb2010
                        Largest       Std. Dev.      6384.909
75%    15sep2018      15jan2021
90%    15jan2020      15jan2021       Variance       4.08e+07
95%    15jul2020      15jan2021       Skewness       -4.74719
99%    15nov2020      15jan2021       Kurtosis       29.39724

                   kidney_transplant_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15dec1899
 5%    15jan1988      15dec1899
10%    15sep1994      15dec1899       Obs              15,704
25%    15may2004      15jan1900       Sum of Wgt.      15,704

50%    15dec2011                      Mean          28mar2008
                        Largest       Std. Dev.      5527.094
75%    15nov2016      15jan2021
90%    15mar2019      15jan2021       Variance       3.05e+07
95%    15jan2020      15jan2021       Skewness      -4.462126
99%    15oct2020      15jan2021       Kurtosis        30.8797

                    other_transplant_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1962      15jan1900
 5%    15dec1992      15jan1900
10%    15jan1997      15jan1900       Obs               4,897
25%    15feb2004      15jan1900       Sum of Wgt.       4,897

50%    15dec2010                      Mean          13jun2008
                        Largest       Std. Dev.      4854.978
75%    15mar2016      15dec2020
90%    15dec2018      15dec2020       Variance       2.36e+07
95%    15oct2019      15jan2021       Skewness      -4.907539
99%    15sep2020      15jan2021       Kurtosis       38.83923

                      hypertension_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1800
 5%    15nov1986      15jan1800
10%    15feb1994      15jan1800       Obs           3,963,926
25%    15jan2002      15jan1800       Sum of Wgt.   3,963,926

50%    15may2008                      Mean          09dec2004
                        Largest       Std. Dev.      7204.061
75%    15jan2015      15jul2037
90%    15jul2018      15sep2037       Variance       5.19e+07
95%    15aug2019      15jun2055       Skewness      -4.116419
99%    15sep2020      15nov2056       Kurtosis       22.09568

                    ra_sle_psoriasis_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1800
 5%    15mar1972      15jan1800
10%    15jan1985      15jan1840       Obs             971,925
25%    15may1998      15jan1840       Sum of Wgt.     971,925

50%    15dec2007                      Mean          10nov2002
                        Largest       Std. Dev.      7303.414
75%    15jul2014      15jan2021
90%    15mar2018      15dec2021       Variance       5.33e+07
95%    15may2019      15mar2082       Skewness      -3.110793
99%    15aug2020      15mar3000       Kurtosis       22.70942

                           asthma
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs          23,349,395
25%            0              0       Sum of Wgt.    23349395

50%            0                      Mean           .1608861
                        Largest       Std. Dev.      .4058494
75%            0              2
90%            1              2       Variance       .1647137
95%            1              2       Skewness       2.488552
99%            2              2       Kurtosis       8.682465

                        diabetes_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    15jan1900      15jan1860
 5%    15may1995      15jan1860
10%    15jan2001      15jan1860       Obs           1,812,275
25%    15jan2007      15jan1860       Sum of Wgt.   1,812,275

50%    15jun2013                      Mean          26feb2010
                        Largest       Std. Dev.      5273.195
75%    15aug2017      15feb2020
90%    15feb2019      15feb2020       Variance       2.78e+07
95%    15aug2019      15feb2020       Skewness      -5.503032
99%    15dec2019      15feb2020       Kurtosis       41.03212

                       covid_icu_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    18mar2020      01mar2020
 5%    26mar2020      02mar2020
10%    30mar2020      02mar2020       Obs               8,405
25%    13apr2020      07mar2020       Sum of Wgt.       8,405

50%    28oct2020                      Mean          01sep2020
                        Largest       Std. Dev.      118.2652
75%    22dec2020      19jan2021
90%    09jan2021      19jan2021       Variance       13986.66
95%    13jan2021      19jan2021       Skewness       -.310447
99%    17jan2021      20jan2021       Kurtosis       1.308536

                  positive_covid_test_ever
-------------------------------------------------------------
      Percentiles      Smallest
 1%    31mar2020      01feb2020
 5%    29apr2020      05feb2020
10%    07aug2020      08feb2020       Obs             898,245
25%    21oct2020      08feb2020       Sum of Wgt.     898,245

50%    25nov2020                      Mean          07nov2020
                        Largest       Std. Dev.      70.85681
75%    29dec2020      14jan2021
90%    06jan2021      14jan2021       Variance       5020.688
95%    10jan2021      14jan2021       Skewness      -1.796543
99%    13jan2021      14jan2021       Kurtosis       5.666551

                        died_date_ons
-------------------------------------------------------------
      Percentiles      Smallest
 1%    04feb2020      01feb2020
 5%    19feb2020      01feb2020
10%    07mar2020      01feb2020       Obs             202,755
25%    15apr2020      01feb2020       Sum of Wgt.     202,755

50%    04jul2020                      Mean          14jul2020
                        Largest       Std. Dev.      101.3326
75%    17oct2020      11jan2021
90%    05dec2020      11jan2021       Variance       10268.29
95%    21dec2020      11jan2021       Skewness       .1471089
99%    03jan2021      11jan2021       Kurtosis       1.684858

                    covid_admission_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%    04mar2020      01feb2020
 5%    21mar2020      01feb2020
10%    27mar2020      01feb2020       Obs              59,653
25%    07apr2020      02feb2020       Sum of Wgt.      59,653

50%    08may2020                      Mean          25jun2020
                        Largest       Std. Dev.      92.97992
75%    15oct2020      30nov2020
90%    07nov2020      30nov2020       Variance       8645.266
95%    15nov2020      30nov2020       Skewness       .4802691
99%    24nov2020      30nov2020       Kurtosis       1.481626

                     covid_tpp_probable
-------------------------------------------------------------
      Percentiles      Smallest
 1%    31mar2020      01jan1900
 5%    27apr2020      01jan1900
10%    16jun2020      01jan1900       Obs             953,154
25%    20oct2020      01jan1900       Sum of Wgt.     953,154

50%    22nov2020                      Mean          30oct2020
                        Largest       Std. Dev.      405.6089
75%    28dec2020      14jan2021
90%    06jan2021      14jan2021       Variance       164518.6
95%    10jan2021      14jan2021       Skewness      -100.8154
99%    13jan2021      01dec2021       Kurtosis       10778.51

                covid_admission_primary_date
-------------------------------------------------------------
      Percentiles      Smallest
 1%        21988          21947
 5%        21997          21949
10%        22002          21949       Obs              36,872
25%        22010          21951       Sum of Wgt.      36,872

50%        22034                      Mean           22087.29
                        Largest       Std. Dev.      93.26972
75%        22202          22249
90%        22227          22249       Variance        8699.24
95%        22234          22249       Skewness       .5929863
99%        22242          22249       Kurtosis       1.555135

                covid_primary_care_codes_only
-------------------------------------------------------------
      Percentiles      Smallest
 1%    30mar2020      01jan1900
 5%    22apr2020      01jan1900
10%    18may2020      01jan1900       Obs             468,634
25%    01oct2020      01jan1900       Sum of Wgt.     468,634

50%    29oct2020                      Mean          27sep2020
                        Largest       Std. Dev.      572.4771
75%    16nov2020      13jan2021
90%    02dec2020      13jan2021       Variance         327730
95%    14dec2020      13jan2021       Skewness      -72.75268
99%    08jan2021      01dec2021       Kurtosis       5507.417

. 
. 
. /* CREATE VARIABLES==========================================================
> =*/
. 
. /* DEMOGRAPHICS */ 
. 
. * Sex
. gen male = 1 if sex == "M"
(11,668,515 missing values generated)

. replace male = 0 if sex == "F"
(11,668,098 real changes made)

. 
. * Ethnicity 
. replace ethnicity = .u if ethnicity == .
(6,280,651 real changes made, 6,280,651 to missing)

. 
. label define ethnicity  1 "White"                                       ///
>                                                 2 "Mixed"                    
>                    ///
>                                                 3 "Asian or Asian British"   
>    ///
>                                                 4 "Black"                    
>                    ///
>                                                 5 "Other"                    
>                    ///
>                                                 .u "Unknown"

. 
. label values ethnicity ethnicity

. 
. * STP 
. rename stp stp_old

. bysort stp_old: gen stp = 1 if _n==1
(23,349,363 missing values generated)

. replace stp = sum(stp)
(23,349,394 real changes made)

. drop stp_old

. 
. /*  IMD  */
. * Group into 5 groups
. rename imd imd_o

. egen imd = cut(imd_o), group(5) icodes

. 
. * add one to create groups 1 - 5 
. replace imd = imd + 1
(23,349,395 real changes made)

. 
. * - 1 is missing, should be excluded from population 
. replace imd = .u if imd_o == -1
(246,203 real changes made, 246,203 to missing)

. drop imd_o

. 
. * Reverse the order (so high is more deprived)
. recode imd 5 = 1 4 = 2 3 = 3 2 = 4 1 = 5 .u = .u
(imd: 18389505 changes made)

. 
. label define imd 1 "1 least deprived" 2 "2" 3 "3" 4 "4" 5 "5 most deprived" .
> u "Unknown"

. label values imd imd 

. 
. /*  Age variables  */ 
. 
. * Create categorised age 
. recode age 18/29.9999 = 1 /// 
>                    30/39.9999 = 2 /// 
>            40/49.9999 = 3 ///
>                    50/59.9999 = 4 ///
>                60/69.9999 = 5 ///
>                    70/79.9999 = 6 ///
>                    80/max = 7, gen(agegroup) 
(18677950 differences between age and agegroup)

. 
. label define agegroup   1 "18-<30" ///
>                                                 2 "30-<40" ///
>                                                 3 "40-<50" ///
>                                                 4 "50-<60" ///
>                                                 5 "60-<70" ///
>                                                 6 "70-<80" ///
>                                                 7 "80+"

.                                                 
. label values agegroup agegroup

. 
. * Create binary age (for age stratification)
. recode age min/65.999999999 = 0 ///
>            66/max = 1, gen(age66)
(23209560 differences between age and age66)

. 
. * Check there are no missing ages
. assert age < .

. assert agegroup < .

. assert age66 < .

. 
. 
. /* APPLY HH level INCLUSION/EXCLUIONS========================================
> ==========*/ 
. 
. noi di "DROP if HH ID==0"
DROP if HH ID==0

. count if household_id==0
  2,953,687

. drop if household_id==0
(2,953,687 observations deleted)

. count
  20,395,708

. 
. drop if care_home_type!="U"
(96,964 observations deleted)

. count
  20,298,744

. 
. noi di "DROP HH>=10 persons:"
DROP HH>=10 persons:

. sum household_size, d

                       household_size
-------------------------------------------------------------
      Percentiles      Smallest
 1%            1              1
 5%            1              1
10%            1              1       Obs          20,298,744
25%            2              1       Sum of Wgt.    20298744

50%            3                      Mean           5.375629
                        Largest       Std. Dev.      48.82945
75%            4           2589
90%            6           2589       Variance       2384.316
95%            7           2589       Skewness       31.87088
99%           12           2589       Kurtosis       1277.084

. drop if household_size>=10
(350,020 observations deleted)

. count
  19,948,724

. 
. noi di "DROP AGE MISSING:"
DROP AGE MISSING:

. recode age .=9
(age: 0 changes made)

. recode age .u=9
(age: 0 changes made)

. bysort household_id: egen age_drop=max(age)

. drop if age_drop==9
(13,194 observations deleted)

. count
  19,935,530

. 
. **************************** HOUSEHOLD VARS**********************************
> *********
. 
. *No kids/kids under 12/up to 18
. *Identify kids under 12, or kids under 18
. gen nokids=1 if age<5
(18,884,962 missing values generated)

. recode nokids .=2 if age<12
(nokids: 1728561 changes made)

. recode nokids .=3 if age<18 
(nokids: 1339800 changes made)

. 
. preserve

. keep if age<18
(15,816,601 observations deleted)

. keep household_id nokids

. duplicates drop

Duplicates in terms of all variables

(920,424 observations deleted)

. bysort household_id: replace nokids=4 if _N>1
(1517779 real changes made)

. duplicates drop

Duplicates in terms of all variables

(789,727 observations deleted)

. rename nokids kids_cat5

. list in 1/100

     +---------------------+
     | househ~d   kids_c~5 |
     |---------------------|
  1. |       19          3 |
  2. |       25          3 |
  3. |       29          2 |
  4. |       31          3 |
  5. |       33          3 |
     |---------------------|
  6. |       35          3 |
  7. |       49          2 |
  8. |       50          3 |
  9. |       62          3 |
 10. |       64          3 |
     |---------------------|
 11. |       82          3 |
 12. |       89          3 |
 13. |       95          3 |
 14. |      105          3 |
 15. |      108          3 |
     |---------------------|
 16. |      124          3 |
 17. |      126          3 |
 18. |      132          2 |
 19. |      148          3 |
 20. |      158          2 |
     |---------------------|
 21. |      164          3 |
 22. |      165          2 |
 23. |      181          2 |
 24. |      188          3 |
 25. |      192          3 |
     |---------------------|
 26. |      201          3 |
 27. |      203          3 |
 28. |      215          3 |
 29. |      224          3 |
 30. |      230          3 |
     |---------------------|
 31. |      236          3 |
 32. |      237          3 |
 33. |      246          3 |
 34. |      249          3 |
 35. |      275          3 |
     |---------------------|
 36. |      280          1 |
 37. |      282          1 |
 38. |      290          3 |
 39. |      293          3 |
 40. |      303          3 |
     |---------------------|
 41. |      306          3 |
 42. |      312          3 |
 43. |      326          1 |
 44. |      327          3 |
 45. |      328          3 |
     |---------------------|
 46. |      337          3 |
 47. |      341          3 |
 48. |      343          2 |
 49. |      345          3 |
 50. |      346          3 |
     |---------------------|
 51. |      348          3 |
 52. |      351          3 |
 53. |      372          3 |
 54. |      383          3 |
 55. |      387          3 |
     |---------------------|
 56. |      402          3 |
 57. |      412          3 |
 58. |      424          1 |
 59. |      425          1 |
 60. |      430          2 |
     |---------------------|
 61. |      439          3 |
 62. |      441          3 |
 63. |      450          2 |
 64. |      452          1 |
 65. |      453          3 |
     |---------------------|
 66. |      457          1 |
 67. |      463          1 |
 68. |      474          3 |
 69. |      483          3 |
 70. |      492          1 |
     |---------------------|
 71. |      498          1 |
 72. |      508          3 |
 73. |      516          2 |
 74. |      517          1 |
 75. |      529          1 |
     |---------------------|
 76. |      547          1 |
 77. |      554          1 |
 78. |      556          3 |
 79. |      557          2 |
 80. |      558          1 |
     |---------------------|
 81. |      567          3 |
 82. |      571          3 |
 83. |      574          3 |
 84. |      576          3 |
 85. |      580          3 |
     |---------------------|
 86. |      581          3 |
 87. |      586          3 |
 88. |      588          3 |
 89. |      592          3 |
 90. |      594          3 |
     |---------------------|
 91. |      595          3 |
 92. |      603          3 |
 93. |      605          3 |
 94. |      614          3 |
 95. |      620          3 |
     |---------------------|
 96. |      621          3 |
 97. |      625          3 |
 98. |      628          3 |
 99. |      630          2 |
100. |      642          3 |
     +---------------------+

. save kids_mixed_category, replace
file kids_mixed_category.dta saved

. restore

. 
. merge m:1 household_id using kids_mixed_category, nogen keep(master match)

    Result                           # of obs.
    -----------------------------------------
    not matched                    11,266,771
        from master                11,266,771  
        from using                          0  

    matched                         8,668,759  
    -----------------------------------------

. 
. lab define   kids_cat5 0 none  1 "only <5 years" ///
> 2 "only 5-11" 3 "12-<18" 4 "mixed"

. lab val kids_cat5 kids_cat5

. recode kids_cat5 .=0
(kids_cat5: 11266771 changes made)

. tab kids_cat5

    kids_cat5 |      Freq.     Percent        Cum.
--------------+-----------------------------------
         none | 11,266,771       56.52       56.52
only <5 years |  1,416,087        7.10       63.62
    only 5-11 |  1,887,663        9.47       73.09
       12-<18 |  2,023,323       10.15       83.24
        mixed |  3,341,686       16.76      100.00
--------------+-----------------------------------
        Total | 19,935,530      100.00

. drop nokids

. 
. *Identify kids under 12, or kids under 18
. gen nokids=1 if age<12
(17,156,401 missing values generated)

. recode nokids .=2 if age<18 
(nokids: 1339800 changes made)

. 
. preserve

. keep if age<18
(15,816,601 observations deleted)

. keep household_id nokids

. duplicates drop

Duplicates in terms of all variables

(1,277,476 observations deleted)

. bysort household_id: replace nokids=3 if _N>1
(865350 real changes made)

. duplicates drop

Duplicates in terms of all variables

(432,675 observations deleted)

. rename nokids kids_cat4

. list in 1/100

     +---------------------+
     | househ~d   kids_c~4 |
     |---------------------|
  1. |       19          2 |
  2. |       25          2 |
  3. |       29          1 |
  4. |       31          2 |
  5. |       33          2 |
     |---------------------|
  6. |       35          2 |
  7. |       49          1 |
  8. |       50          2 |
  9. |       62          2 |
 10. |       64          2 |
     |---------------------|
 11. |       82          2 |
 12. |       89          2 |
 13. |       95          2 |
 14. |      105          2 |
 15. |      108          2 |
     |---------------------|
 16. |      124          2 |
 17. |      126          2 |
 18. |      132          1 |
 19. |      148          2 |
 20. |      158          1 |
     |---------------------|
 21. |      164          2 |
 22. |      165          1 |
 23. |      181          1 |
 24. |      188          2 |
 25. |      192          2 |
     |---------------------|
 26. |      201          2 |
 27. |      203          2 |
 28. |      215          2 |
 29. |      224          2 |
 30. |      230          2 |
     |---------------------|
 31. |      236          2 |
 32. |      237          2 |
 33. |      246          2 |
 34. |      249          2 |
 35. |      275          2 |
     |---------------------|
 36. |      280          1 |
 37. |      282          1 |
 38. |      290          2 |
 39. |      293          2 |
 40. |      303          2 |
     |---------------------|
 41. |      306          2 |
 42. |      312          2 |
 43. |      326          1 |
 44. |      327          2 |
 45. |      328          2 |
     |---------------------|
 46. |      337          2 |
 47. |      341          2 |
 48. |      343          1 |
 49. |      345          2 |
 50. |      346          2 |
     |---------------------|
 51. |      348          2 |
 52. |      351          2 |
 53. |      372          2 |
 54. |      383          2 |
 55. |      387          2 |
     |---------------------|
 56. |      402          2 |
 57. |      412          2 |
 58. |      424          1 |
 59. |      425          1 |
 60. |      430          1 |
     |---------------------|
 61. |      439          2 |
 62. |      441          2 |
 63. |      450          1 |
 64. |      452          1 |
 65. |      453          2 |
     |---------------------|
 66. |      457          1 |
 67. |      463          1 |
 68. |      474          2 |
 69. |      483          2 |
 70. |      492          1 |
     |---------------------|
 71. |      498          1 |
 72. |      508          2 |
 73. |      516          1 |
 74. |      517          1 |
 75. |      529          1 |
     |---------------------|
 76. |      547          1 |
 77. |      554          1 |
 78. |      556          2 |
 79. |      557          1 |
 80. |      558          1 |
     |---------------------|
 81. |      567          2 |
 82. |      571          2 |
 83. |      574          2 |
 84. |      576          2 |
 85. |      580          2 |
     |---------------------|
 86. |      581          2 |
 87. |      586          2 |
 88. |      588          2 |
 89. |      592          2 |
 90. |      594          2 |
     |---------------------|
 91. |      595          2 |
 92. |      603          2 |
 93. |      605          2 |
 94. |      614          2 |
 95. |      620          2 |
     |---------------------|
 96. |      621          2 |
 97. |      625          2 |
 98. |      628          2 |
 99. |      630          1 |
100. |      642          2 |
     +---------------------+

. save kids_mixed_category, replace
file kids_mixed_category.dta saved

. restore

. 
. merge m:1 household_id using kids_mixed_category, nogen keep(master match)

    Result                           # of obs.
    -----------------------------------------
    not matched                    11,266,771
        from master                11,266,771  
        from using                          0  

    matched                         8,668,759  
    -----------------------------------------

. 
. lab define   kids_cat4 0 none  1 "only <12 years" ///
> 2 "only 12-18" ///
> 3 "mixed"

. lab val kids_cat4 kids_cat4

. recode kids_cat4 .=0
(kids_cat4: 11266771 changes made)

. tab kids_cat4

     kids_cat4 |      Freq.     Percent        Cum.
---------------+-----------------------------------
          none | 11,266,771       56.52       56.52
only <12 years |  4,588,050       23.01       79.53
    only 12-18 |  2,023,323       10.15       89.68
         mixed |  2,057,386       10.32      100.00
---------------+-----------------------------------
         Total | 19,935,530      100.00

. 
. *Dose-response exposure
. bysort household_id: egen number_kids=sum(nokids) if kids_cat4==1
(15347480 missing values generated)

. 
. gen gp_number_kids=number_kids
(15,347,480 missing values generated)

. recode gp_number_kids 4/max=4
(gp_number_kids: 30696 changes made)

. 
. lab var gp_number_kids "Number kids under 12 years in hh"

. lab define   gp_number_kids 0 none ///
> 1 "1 child <12" ///
> 2 "2 children <12" ///
> 3 "3 children <12" ///
> 4 "4+ children <12"

. lab val gp_number_kids gp_number_kids

. 
. tab kids_cat4 

     kids_cat4 |      Freq.     Percent        Cum.
---------------+-----------------------------------
          none | 11,266,771       56.52       56.52
only <12 years |  4,588,050       23.01       79.53
    only 12-18 |  2,023,323       10.15       89.68
         mixed |  2,057,386       10.32      100.00
---------------+-----------------------------------
         Total | 19,935,530      100.00

. tab kids_cat5

    kids_cat5 |      Freq.     Percent        Cum.
--------------+-----------------------------------
         none | 11,266,771       56.52       56.52
only <5 years |  1,416,087        7.10       63.62
    only 5-11 |  1,887,663        9.47       73.09
       12-<18 |  2,023,323       10.15       83.24
        mixed |  3,341,686       16.76      100.00
--------------+-----------------------------------
        Total | 19,935,530      100.00

. tab kids_cat*

              |                  kids_cat4
    kids_cat5 |      none  only <12   only 12-1      mixed |     Total
--------------+--------------------------------------------+----------
         none |11,266,771          0          0          0 |11,266,771 
only <5 years |         0  1,416,087          0          0 | 1,416,087 
    only 5-11 |         0  1,887,663          0          0 | 1,887,663 
       12-<18 |         0          0  2,023,323          0 | 2,023,323 
        mixed |         0  1,284,300          0  2,057,386 | 3,341,686 
--------------+--------------------------------------------+----------
        Total |11,266,771  4,588,050  2,023,323  2,057,386 |19,935,530 

. 
. 
. /* DROP ALL KIDS, AS HH COMPOSITION VARS ARE NOW MADE */
. drop if age<18
(4,118,929 observations deleted)

. 
. *Total number adults in household (to check hh size)
. bysort household_id: gen tot_adults_hh=_N

. recode tot_adults_hh 3/max=3
(tot_adults_hh: 2217450 changes made)

. 
. tab kids_cat4

     kids_cat4 |      Freq.     Percent        Cum.
---------------+-----------------------------------
          none | 11,266,771       71.23       71.23
only <12 years |  2,428,193       15.35       86.59
    only 12-18 |  1,232,024        7.79       94.38
         mixed |    889,613        5.62      100.00
---------------+-----------------------------------
         Total | 15,816,601      100.00

. tab gp_num if kids_cat4==1

    Number kids |
 under 12 years |
          in hh |      Freq.     Percent        Cum.
----------------+-----------------------------------
    1 child <12 |  1,239,003       51.03       51.03
 2 children <12 |    925,267       38.11       89.13
 3 children <12 |    213,397        8.79       97.92
4+ children <12 |     50,526        2.08      100.00
----------------+-----------------------------------
          Total |  2,428,193      100.00

. 
. /* SET FU DATES==============================================================
> =*/ 
. * Censoring dates for each outcome (largely, last date outcome data available
> )
. *****NEEDS UPDATING WHEN INFO AVAILABLE*******************
. 
. * Note - outcome dates are handled separtely below 
. 
. * Some names too long for loops below, shorten
. rename permanent_immunodeficiency_date  perm_immunodef_date

. rename temporary_immunodeficiency_date  temp_immunodef_date

. rename bmi_date_measured_date                   bmi_measured_date

. rename dereg_date_date                                          dereg_date

. 
. /* CREATE BINARY VARIABLES===================================================
> =*/
. *  Make indicator variables for all conditions where relevant 
. 
. foreach var of varlist  chronic_respiratory_disease ///
>                                                 chronic_cardiac_disease  ///
>                                                 diabetes_date  ///
>                                                 cancer_haem  ///
>                                                 cancer_nonhaem  ///
>                                                 perm_immunodef  ///
>                                                 temp_immunodef  ///
>                                                 dialysis                     
>                    ///
>                                                 kidney_transplant            
>            ///
>                                                 other_transplant             
>            /// 
>                                                 asplenia                     
>    /// 
>                                                 chronic_liver_disease  ///
>                                                 other_neuro  ///
>                                                 stroke_dementia              
>            ///
>                                                 esrf  ///
>                                                 hypertension  ///
>                                                 ra_sle_psoriasis  ///
>                                                 bmi_measured_date   ///
>                                                 bp_sys_date_measured   ///
>                                                 bp_dias_date_measured   ///
>                                                 creatinine_date  ///
>                                                 smoking_status_date ///
>                                                 {
  2.                                                 
.         /* date ranges are applied in python, so presence of date indicates p
> resence of 
>           disease in the correct time frame */ 
.         local newvar =  substr("`var'", 1, length("`var'") - 5)
  3.         gen `newvar' = (`var'!=. )
  4.         order `newvar', after(`var')
  5.         
. }

. 
. 
. 
. 
. /*  Body Mass Index  */
. * NB: watch for missingness
. 
. * Recode strange values 
. replace bmi = . if bmi == 0 
(3,025,111 real changes made, 3,025,111 to missing)

. replace bmi = . if !inrange(bmi, 15, 50)
(124,229 real changes made, 124,229 to missing)

. 
. * Restrict to within 10 years of index and aged > 16 
. gen bmi_time = (date("$indexdate", "DMY") - bmi_measured_date)/365.25
(2,971,689 missing values generated)

. gen bmi_age = age - bmi_time
(2,971,689 missing values generated)

. 
. replace bmi = . if bmi_age < 16 
(40,573 real changes made, 40,573 to missing)

. replace bmi = . if bmi_time > 10 & bmi_time != . 
(0 real changes made)

. 
. * Set to missing if no date, and vice versa 
. replace bmi = . if bmi_measured_date == . 
(0 real changes made)

. replace bmi_measured_date = . if bmi == . 
(218,224 real changes made, 218,224 to missing)

. replace bmi_measured = . if bmi == . 
(3,189,913 real changes made, 3,189,913 to missing)

. 
. gen     bmicat = .
(15,816,601 missing values generated)

. recode  bmicat . = 1 if bmi < 18.5
(bmicat: 291715 changes made)

. recode  bmicat . = 2 if bmi < 25
(bmicat: 4501689 changes made)

. recode  bmicat . = 3 if bmi < 30
(bmicat: 4336028 changes made)

. recode  bmicat . = 4 if bmi < 35
(bmicat: 2201245 changes made)

. recode  bmicat . = 5 if bmi < 40
(bmicat: 858084 changes made)

. recode  bmicat . = 6 if bmi < .
(bmicat: 437927 changes made)

. replace bmicat = .u if bmi >= .
(3,189,913 real changes made, 3,189,913 to missing)

. 
. label define bmicat 1 "Underweight (<18.5)"     ///
>                                         2 "Normal (18.5-24.9)"          ///
>                                         3 "Overweight (25-29.9)"        ///
>                                         4 "Obese I (30-34.9)"           ///
>                                         5 "Obese II (35-39.9)"          ///
>                                         6 "Obese III (40+)"                  
>    ///
>                                         .u "Unknown (.u)"

.                                         
. label values bmicat bmicat

. 
. * Create less  granular categorisation
. recode bmicat 1/3 .u = 1 4 = 2 5 = 3 6 = 4, gen(obese4cat)
(15524886 differences between bmicat and obese4cat)

. 
. label define obese4cat  1 "No record of obesity"        ///
>                                                 2 "Obese I (30-34.9)"        
>    ///
>                                                 3 "Obese II (35-39.9)"       
>    ///
>                                                 4 "Obese III (40+)"          
>    

. 
. label values obese4cat obese4cat

. order obese4cat, after(bmicat)

. 
. 
. /*  Smoking  */
. 
. * Smoking 
. label define smoke 1 "Never" 2 "Former" 3 "Current" .u "Unknown (.u)"

. 
. gen     smoke = 1  if smoking_status == "N"
(8,561,052 missing values generated)

. replace smoke = 2  if smoking_status == "E"
(5,173,767 real changes made)

. replace smoke = 3  if smoking_status == "S"
(2,758,473 real changes made)

. replace smoke = .u if smoking_status == "M"
(628,812 real changes made, 628,812 to missing)

. replace smoke = .u if smoking_status == "" 
(0 real changes made)

. 
. label values smoke smoke

. drop smoking_status

. 
. * Create non-missing 3-category variable for current smoking
. * Assumes missing smoking is never smoking 
. recode smoke .u = 1, gen(smoke_nomiss)
(628812 differences between smoke and smoke_nomiss)

. order smoke_nomiss, after(smoke)

. label values smoke_nomiss smoke

. 
. /* CLINICAL COMORBIDITIES */ 
. 
. /*  Cancer */
. label define cancer 1 "Never" 2 "Last year" 3 "2-5 years ago" 4 "5+ years"

. 
. * Haematological malignancies
. gen     cancer_haem_cat = 4 if inrange(cancer_haem_date, d(1/1/1900), d(1/2/2
> 015))
(15,759,558 missing values generated)

. replace cancer_haem_cat = 3 if inrange(cancer_haem_date, d(1/2/2015), d(1/2/2
> 019))
(25,277 real changes made)

. replace cancer_haem_cat = 2 if inrange(cancer_haem_date, d(1/2/2019), d(1/2/2
> 020))
(8,190 real changes made)

. recode  cancer_haem_cat . = 1
(cancer_haem_cat: 15726091 changes made)

. label values cancer_haem_cat cancer

. 
. 
. * All other cancers
. gen     cancer_exhaem_cat = 4 if inrange(cancer_nonhaem_date,  d(1/1/1900), d
> (1/2/2015)) 
(15,331,746 missing values generated)

. replace cancer_exhaem_cat = 3 if inrange(cancer_nonhaem_date,  d(1/2/2015), d
> (1/2/2019))
(210,111 real changes made)

. replace cancer_exhaem_cat = 2 if inrange(cancer_nonhaem_date,  d(1/2/2019), d
> (1/2/2020)) 
(71,811 real changes made)

. recode  cancer_exhaem_cat . = 1
(cancer_exhaem_cat: 15049824 changes made)

. label values cancer_exhaem_cat cancer

. 
. 
. /*  Immunosuppression  */
. 
. * Immunosuppressed:
. * Permanent immunodeficiency ever, OR 
. * Temporary immunodeficiency  last year
. gen temp1  = 1 if perm_immunodef_date!=.
(15,774,201 missing values generated)

. gen temp2  = inrange(temp_immunodef_date, (date("$indexdate", "DMY") - 365), 
> date("$indexdate", "DMY"))

. 
. egen other_immuno = rowmax(temp1 temp2)

. drop temp1 temp2 

. order other_immuno, after(temp_immunodef)

. 
. /*  Blood pressure   */
. 
. * Categorise
. gen     bpcat = 1 if bp_sys < 120 &  bp_dias < 80
(10,667,287 missing values generated)

. replace bpcat = 2 if inrange(bp_sys, 120, 130) & bp_dias<80
(2,733,429 real changes made)

. replace bpcat = 3 if inrange(bp_sys, 130, 140) | inrange(bp_dias, 80, 90)
(7,230,426 real changes made)

. replace bpcat = 4 if (bp_sys>=140 & bp_sys<.) | (bp_dias>=90 & bp_dias<.) 
(3,352,483 real changes made)

. replace bpcat = .u if bp_sys>=. | bp_dias>=. | bp_sys==0 | bp_dias==0
(1,600,479 real changes made, 1,600,479 to missing)

. 
. label define bpcat 1 "Normal" 2 "Elevated" 3 "High, stage I"    ///
>                                         4 "High, stage II" .u "Unknown"

. label values bpcat bpcat

. 
. recode bpcat .u=1, gen(bpcat_nomiss)
(1600479 differences between bpcat and bpcat_nomiss)

. label values bpcat_nomiss bpcat

. 
. * Create non-missing indicator of known high blood pressure
. gen bphigh = (bpcat==4)

. 
. /*  Hypertension  */
. 
. gen htdiag_or_highbp = bphigh

. recode htdiag_or_highbp 0 = 1 if hypertension==1 
(htdiag_or_highbp: 1999248 changes made)

. 
. 
. ************
. *   eGFR   *
. ************
. 
. * Set implausible creatinine values to missing (Note: zero changed to missing
> )
. replace creatinine = . if !inrange(creatinine, 20, 3000) 
(4,079,910 real changes made, 4,079,910 to missing)

.         
. * Divide by 88.4 (to convert umol/l to mg/dl)
. gen SCr_adj = creatinine/88.4
(4,079,910 missing values generated)

. 
. gen min=.
(15,816,601 missing values generated)

. replace min = SCr_adj/0.7 if male==0
(6,413,553 real changes made)

. replace min = SCr_adj/0.9 if male==1
(5,322,923 real changes made)

. replace min = min^-0.329  if male==0
(6,413,553 real changes made)

. replace min = min^-0.411  if male==1
(5,322,923 real changes made)

. replace min = 1 if min<1
(7,723,446 real changes made)

. 
. gen max=.
(15,816,601 missing values generated)

. replace max=SCr_adj/0.7 if male==0
(6,413,553 real changes made)

. replace max=SCr_adj/0.9 if male==1
(5,322,923 real changes made)

. replace max=max^-1.209
(11,736,476 real changes made)

. replace max=1 if max>1
(8,093,155 real changes made)

. 
. gen egfr=min*max*141
(4,080,125 missing values generated)

. replace egfr=egfr*(0.993^age)
(11,736,476 real changes made)

. replace egfr=egfr*1.018 if male==0
(6,413,553 real changes made)

. label var egfr "egfr calculated using CKD-EPI formula with no eth"

. 
. * Categorise into ckd stages
. egen egfr_cat = cut(egfr), at(0, 15, 30, 45, 60, 5000)
(4080125 missing values generated)

. recode egfr_cat 0=5 15=4 30=3 45=2 60=0, generate(ckd)
(11736476 differences between egfr_cat and ckd)

. * 0 = "No CKD"  2 "stage 3a" 3 "stage 3b" 4 "stage 4" 5 "stage 5"
. label define ckd 0 "No CKD" 1 "CKD"

. label values ckd ckd

. *label var ckd "CKD stage calc without eth"
. 
. * Convert into CKD group
. *recode ckd 2/5=1, gen(chronic_kidney_disease)
. *replace chronic_kidney_disease = 0 if creatinine==. 
.         
. recode ckd 0=1 2/3=2 4/5=3, gen(reduced_kidney_function_cat)
(11071226 differences between ckd and reduced_kidney_function_cat)

. replace reduced_kidney_function_cat = 1 if creatinine==. 
(4,079,910 real changes made)

. label define reduced_kidney_function_catlab ///
>         1 "None" 2 "Stage 3a/3b egfr 30-60      " 3 "Stage 4/5 egfr<30"

. label values reduced_kidney_function_cat reduced_kidney_function_catlab 

. lab var  reduced "Reduced kidney function"

. 
. 
. /*ESDR: dialysis or kidney transplant*/
. gen esrd=1 if dialysis==1 | kidney_transplant==1
(15,792,380 missing values generated)

. recode esrd .=0
(esrd: 15792380 changes made)

. 
. 
. 
. ***************************
. /* DM / Hb1AC */
. ***************************
. 
. 
. /*  Diabetes severity  */
. 
. * Set zero or negative to missing
. replace hba1c_percentage   = . if hba1c_percentage <= 0
(13,668,149 real changes made, 13,668,149 to missing)

. replace hba1c_mmol_per_mol = . if hba1c_mmol_per_mol <= 0
(7,421,253 real changes made, 7,421,253 to missing)

. 
. /* Express  HbA1c as percentage  */ 
. 
. * Express all values as perecentage 
. noi summ hba1c_percentage hba1c_mmol_per_mol 

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
hba1c_per~ge |  2,148,452    15.62598    13055.39        .01   1.91e+07
hba1c_mmol~l |  8,395,348    42.33755    3017.886         .4    8688000

. gen     hba1c_pct = hba1c_percentage 
(13,668,149 missing values generated)

. replace hba1c_pct = (hba1c_mmol_per_mol/10.929)+2.15 if hba1c_mmol_per_mol<. 
(8,395,346 real changes made)

. 
. * Valid % range between 0-20  /195 mmol/mol
. replace hba1c_pct = . if !inrange(hba1c_pct, 0, 20) 
(684 real changes made, 684 to missing)

. replace hba1c_pct = round(hba1c_pct, 0.1)
(8,395,376 real changes made)

. 
. 
. /* Categorise hba1c and diabetes  */
. /* Diabetes type */
. gen dm_type=1 if diabetes_type=="T1DM"
(15,732,581 missing values generated)

. replace dm_type=2 if diabetes_type=="T2DM"
(1,116,563 real changes made)

. replace dm_type=3 if diabetes_type=="UNKNOWN_DM"
(353,886 real changes made)

. replace dm_type=0 if diabetes_type=="NO_DM"
(14,262,132 real changes made)

. 
. safetab dm_type diabetes_type
0

           |                diabetes_type
   dm_type |     NO_DM       T1DM       T2DM  UNKNOWN.. |     Total
-----------+--------------------------------------------+----------
         0 |14,262,132          0          0          0 |14,262,132 
         1 |         0     84,020          0          0 |    84,020 
         2 |         0          0  1,116,563          0 | 1,116,563 
         3 |         0          0          0    353,886 |   353,886 
-----------+--------------------------------------------+----------
     Total |14,262,132     84,020  1,116,563    353,886 |15,816,601 

. label define dm_type 0"No DM" 1"T1DM" 2"T2DM" 3"UNKNOWN_DM"

. label values dm_type dm_type

. 
. *Open safely diabetes codes with exeter algorithm
. gen dm_type_exeter_os=1 if diabetes_exeter_os=="T1DM_EX_OS"
(15,744,130 missing values generated)

. replace dm_type_exeter_os=2 if diabetes_exeter_os=="T2DM_EX_OS"
(1,116,460 real changes made)

. replace dm_type_exeter_os=0 if diabetes_exeter_os=="NO_DM"
(14,627,670 real changes made)

. label values  dm_type_exeter_os dm_type

. 
. * Group hba1c
. gen     hba1ccat = 0 if hba1c_pct <  6.5
(8,375,995 missing values generated)

. replace hba1ccat = 1 if hba1c_pct >= 6.5  & hba1c_pct < 7.5
(536,905 real changes made)

. replace hba1ccat = 2 if hba1c_pct >= 7.5  & hba1c_pct < 8
(142,363 real changes made)

. replace hba1ccat = 3 if hba1c_pct >= 8    & hba1c_pct < 9
(155,715 real changes made)

. replace hba1ccat = 4 if hba1c_pct >= 9    & hba1c_pct !=.
(179,289 real changes made)

. label define hba1ccat 0 "<6.5%" 1">=6.5-7.4" 2">=7.5-7.9" 3">=8-8.9" 4">=9"

. label values hba1ccat hba1ccat

. safetab hba1ccat
0

   hba1ccat |      Freq.     Percent        Cum.
------------+-----------------------------------
      <6.5% |  7,440,606       88.00       88.00
  >=6.5-7.4 |    536,905        6.35       94.35
  >=7.5-7.9 |    142,363        1.68       96.04
    >=8-8.9 |    155,715        1.84       97.88
        >=9 |    179,289        2.12      100.00
------------+-----------------------------------
      Total |  8,454,878      100.00

. 
. gen hba1c75=0 if hba1c_pct<7.5
(7,839,090 missing values generated)

. replace hba1c75=1 if hba1c_pct>=7.5 & hba1c_pct!=.
(477,367 real changes made)

. label define hba1c75 0"<7.5" 1">=7.5"

. safetab hba1c75, m
8

    hba1c75 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |  7,977,511       50.44       50.44
          1 |    477,367        3.02       53.46
          . |  7,361,723       46.54      100.00
------------+-----------------------------------
      Total | 15,816,601      100.00

. 
. * Create diabetes, split by control/not
. gen     diabcat = 1 if dm_type==0 | dm_type==.
(1,554,469 missing values generated)

. replace diabcat = 2 if dm_type==1 & inlist(hba1ccat, 0, 1)
(21,736 real changes made)

. replace diabcat = 3 if dm_type==1 & inlist(hba1ccat, 2, 3, 4)
(60,781 real changes made)

. replace diabcat = 4 if dm_type==2 & inlist(hba1ccat, 0, 1)
(699,904 real changes made)

. replace diabcat = 5 if dm_type==2 & inlist(hba1ccat, 2, 3, 4)
(409,707 real changes made)

. replace diabcat = 6 if dm_type==1 & hba1c_pct==. | dm_type==2 & hba1c_pct==.
(8,455 real changes made)

. 
. 
. label define diabcat    1 "No diabetes"                         ///
>                                                 2 "T1DM, controlled"         
>    ///
>                                                 3 "T1DM, uncontrolled"       
>    ///
>                                                 4 "T2DM, controlled"         
>    ///
>                                                 5 "T2DM, uncontrolled"       
>    ///
>                                                 6 "Diabetes, no HbA1c"

. label values diabcat diabcat

. safetab diabcat, m
8

           diabcat |      Freq.     Percent        Cum.
-------------------+-----------------------------------
       No diabetes | 14,262,132       90.17       90.17
  T1DM, controlled |     21,736        0.14       90.31
T1DM, uncontrolled |     60,781        0.38       90.69
  T2DM, controlled |    699,904        4.43       95.12
T2DM, uncontrolled |    409,707        2.59       97.71
Diabetes, no HbA1c |      8,455        0.05       97.76
                 . |    353,886        2.24      100.00
-------------------+-----------------------------------
             Total | 15,816,601      100.00

. recode diabcat .=1
(diabcat: 353886 changes made)

. 
. 
. 
. /*  Asthma  */
. 
. 
. * Asthma  (coded: 0 No, 1 Yes no OCS, 2 Yes with OCS)
. rename asthma asthmacat

. recode asthmacat 0=1 1=2 2=3
(asthmacat: 15816601 changes made)

. label define asthmacat 1 "No" 2 "Yes, no OCS" 3 "Yes with OCS"

. label values asthmacat asthmacat

. 
. gen asthma = (asthmacat==2|asthmacat==3)

. 
. /*  Probable shielding  */
. gen shield=1 if esrd==1 | other_transplant==1 | asthmacat==2 | asthmacat==3 |
>  ///
> chronic_respiratory_disease==1 | cancer_haem==1 | cancer_nonhaem==1 | ///
> asplenia==1 | other_immuno==1
(12,025,557 missing values generated)

. recode shield .=0
(shield: 12025557 changes made)

. 
. /*Any comorbidity*/
. 
. gen anycomorb=1 if chronic_respiratory_disease==1 | ///
>                     asthmacat==2 | asthmacat==3 | ///
>                                         chronic_cardiac_disease==1  | ///
>                                         diabcat==2 | diabcat==3 | diabcat==4 
> | diabcat==5 | diabcat==6 | ///
>                                         cancer_haem==1 | cancer_nonhaem==1 | 
> ///
>                                         esrd==1 | ///
>                                         chronic_liver_disease==1 | ///
>                                         stroke_dementia==1 | ///
>                                         other_neuro==1 | ///
>                                         other_transplant==1 | ///
>                                         asplenia==1 | ///
>                                         ra_sle_psoriasis==1 | ///
>                                         other_immuno==1 
(10,029,864 missing values generated)

. recode anycomorb .=0
(anycomorb: 10029864 changes made)

. tab anyco

  anycomorb |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 10,029,864       63.41       63.41
          1 |  5,786,737       36.59      100.00
------------+-----------------------------------
      Total | 15,816,601      100.00

. 
. * Comorbidities of interest 
. label var asthma                                                "Asthma categ
> ory"

. label var egfr_cat                                              "Calculated e
> GFR"

. label var hypertension                              "Diagnosed hypertension"

. label var chronic_respiratory_disease   "Chronic Respiratory Diseases"

. label var chronic_cardiac_disease               "Chronic Cardiac Diseases"

. label var diabcat                                               "Diabetes"

. label var cancer_haem_cat                                               "Haem
> atological cancer"

. label var cancer_exhaem_cat                                             "Non-
> haematological cancer"

. label var kidney_transplant                                             "Kidn
> ey transplant"     

. label var other_transplant                                              "Othe
> r solid organ transplant"

. label var asplenia                                              "Asplenia"

. label var other_immuno                                  "Immunosuppressed (co
> mbination algorithm)"

. label var chronic_liver_disease                 "Chronic liver disease"

. label var other_neuro                   "Neurological disease"               
>    

. label var stroke_dementia                           "Stroke or dementia"     
>                                                    

. label var ra_sle_psoriasis                              "Autoimmune disease"

. lab var egfr                                                    eGFR

. lab var perm_immunodef                                  "Permanent immunosupp
> ression"

. lab var temp_immunodef                                  "Temporary immunosupp
> ression"

. lab var esrd                                                    "End-stage re
> nal disease"

. 
. 
. /* OUTCOME AND SURVIVAL TIME=================================================
> =*/
. 
. gen enter_date = date("$indexdate", "DMY")

. gen study_end_censor =date("$study_end_censor", "DMY")

. 
. * Format the dates
. format  enter_date                                      ///
>                 study_end_censor  

  variable name     display format
  --------------------------------
  enter_date        %9.0g
  study_end_censor  %9.0g
  --------------------------------

.                 
.                         /****   Outcome definitions   ****/
. 
. * Date of Covid death in ONS
. gen died_date_onscovid = died_date_ons if died_ons_covid_flag_any == 1
(15,796,636 missing values generated)

. gen died_date_onscovid_part1 = died_date_ons if died_ons_covid_flag_underlyin
> g == 1
(15,798,919 missing values generated)

. 
. * Date of non-COVID death in ONS 
. * If missing date of death resulting died_date will also be missing
. gen died_date_onsnoncovid = died_date_ons if died_ons_covid_flag_any != 1 
(15,690,140 missing values generated)

. 
. *Date probable covid in TPP
. rename covid_tpp_probable date_covid_tpp_prob

. 
. format died_date_ons %td

. format died_date_onscovid %td 

. format died_date_onsnoncovid %td

. format covid_icu_date %td 

. format died_date_onscovid_part1 %td

. format covid_admission_primary_date %td

. 
. * Binary indicators for outcomes
. gen covid_tpp_prob = (date_covid_tpp_prob < .)

. gen non_covid_death = (died_date_onsnoncovid < .)

. gen covid_death = (died_date_onscovid < .)

. gen covid_icu = (covid_icu_date < .)

. gen covidadmission = (covid_admission_primary_date < .)

. gen covid_death_part1 = (died_date_onscovid_part1 < .)

. 
.                                         /**** Create survival times  ****/
. * For looping later, name must be stime_binary_outcome_name
. 
. * Survival time = last followup date (first: end study, death, or that outcom
> e)
. *gen stime_onscoviddeath = min(onscoviddeathcensor_date,                     
>            died_date_ons)
. gen stime_covid_death_part1     = min(study_end_censor   , died_date_onscovid
> _part1, died_date_ons, dereg_date)

. gen stime_covid_tpp_prob = min(study_end_censor   , died_date_ons, date_covid
> _tpp_prob, dereg_date)

. gen stime_non_covid_death = min(study_end_censor   , died_date_ons, died_date
> _onsnoncovid, dereg_date)

. gen stime_covid_death = min(study_end_censor   , died_date_ons, died_date_ons
> covid, dereg_date)

. gen stime_covid_icu = min(study_end_censor, died_date_ons, covid_icu_date, de
> reg_date)

. gen stime_covidadmission        = min(study_end_censor   , covid_admission_pr
> imary_date, died_date_ons, dereg_date)

. 
. * If outcome was after censoring occurred, set to zero
. replace covid_tpp_prob = 0 if (date_covid_tpp_prob > study_end_censor ) 
(606,342 real changes made)

. replace non_covid_death = 0 if (died_date_onsnoncovid > study_end_censor )
(46,521 real changes made)

. replace covid_death = 0 if (died_date_onscovid > study_end_censor )
(9,572 real changes made)

. replace covid_icu = 0 if (covid_icu_date > study_end_censor)
(4,252 real changes made)

. replace covidadmission  = 0 if (covid_admission_primary_date > study_end_cens
> or  | covid_admission_primary_date > died_date_ons) 
(9,941 real changes made)

. replace covid_death_part1 = 0 if (died_date_onscovid_part1 > study_end_censor
>  )
(8,223 real changes made)

. 
. * If outcome was after censoring occurred, set date to missing
. replace date_covid_tpp_prob = . if (date_covid_tpp_prob > study_end_censor ) 
(606,342 real changes made, 606,342 to missing)

. replace died_date_onsnoncovid = . if (died_date_onsnoncovid > study_end_censo
> r )
(46,521 real changes made, 46,521 to missing)

. replace died_date_onscovid = . if (died_date_onscovid > study_end_censor )
(9,572 real changes made, 9,572 to missing)

. replace covid_icu_date = . if (covid_icu_date > study_end_censor)
(4,252 real changes made, 4,252 to missing)

. replace covid_admission_primary_date    = . if (covid_admission_primary_date 
> > study_end_censor  | covid_admission_primary_date > died_date_ons) 
(9,941 real changes made, 9,941 to missing)

. replace died_date_onscovid_part1 = . if (died_date_onscovid_part1 > study_end
> _censor )
(8,223 real changes made, 8,223 to missing)

. 
. 
. * Format date variables
. format  stime* %td  

. gen positive_SGSS = (positive_covid_test_ever < .)

. gen covid_primary_care_codes = (covid_primary_care_codes_only < .)

. rename positive_covid_test_ever date_positive_SGSS

. rename covid_primary_care_codes_only date_covid_primary_care_codes

. replace covid_primary_care_codes = 0 if (date_covid_primary_care_codes > stud
> y_end_censor )
(278,756 real changes made)

. replace positive_SGSS = 0 if (date_positive_SGSS > study_end_censor )
(583,954 real changes made)

. 
. replace date_covid_primary_care_codes = . if (date_covid_primary_care_codes >
>  study_end_censor )
(278,756 real changes made, 278,756 to missing)

. replace date_positive_SGSS = . if (date_positive_SGSS > study_end_censor )
(583,954 real changes made, 583,954 to missing)

. 
. 
. 
. /* LABEL VARIABLES===========================================================
> =*/
. *  Label variables you are intending to keep, drop the rest 
. 
. *HH variable
. label var  number_kids "Number of children aged 1-<12 years in household"

. label var  household_size "Number people in household"

. label var  household_id "Household ID"

. 
. 
. * Demographics
. label var patient_id                            "Patient ID"

. label var age                                           "Age (years)"

. label var agegroup                                      "Grouped age"

. label var age66                                         "66 years and older"

. label var male                                          "Male"

. label var bmi                                           "Body Mass Index (BMI
> , kg/m2)"

. label var bmicat                                        "Grouped BMI"

. label var bmi_measured_date             "Body Mass Index (BMI, kg/m2), date m
> easured"

. label var obese4cat                                     "Evidence of obesity 
> (4 categories)"

. label var smoke                                         "Smoking status"

. label var smoke_nomiss                          "Smoking status (missing set 
> to non)"

. label var imd                                           "Index of Multiple De
> privation (IMD)"

. label var ethnicity                                     "Ethnicity"

. label var stp                                           "Sustainability and T
> ransformation Partnership"

. lab var tot_adults_hh                           "Total number adults in hh"

. lab var kids_cat4                                       "Exposure (v2) with 4
> -cats"

. lab var kids_cat5                                        "Exposure (v3) with 
> 5-cats"

. 
. * Comorbidities of interest 
. label var asthma                                                "Asthma categ
> ory"

. label var egfr_cat                                              "Calculated e
> GFR"

. label var hypertension                              "Diagnosed hypertension"

. label var chronic_respiratory_disease   "Chronic Respiratory Diseases"

. label var chronic_cardiac_disease               "Chronic Cardiac Diseases"

. label var diabcat                                               "Diabetes"

. label var cancer_haem_cat                                               "Haem
> atological cancer"

. label var cancer_exhaem_cat                                             "Non-
> haematological cancer"

. label var kidney_transplant                                             "Kidn
> ey transplant"     

. label var other_transplant                                              "Othe
> r solid organ transplant"

. label var asplenia                                              "Asplenia"

. label var other_immuno                                  "Immunosuppressed (co
> mbination algorithm)"

. label var chronic_liver_disease                 "Chronic liver disease"

. label var other_neuro                   "Neurological disease"               
>    

. label var stroke_dementia                           "Stroke or dementia"     
>                                                    

. label var ra_sle_psoriasis                              "Autoimmune disease"

. lab var egfr                                                    eGFR

. lab var perm_immunodef                                  "Permanent immunosupp
> ression"

. lab var temp_immunodef                                  "Temporary immunosupp
> ression"

. lab var esrd                                                    "End-stage re
> nal disease"

. lab var anycomorb                                               "Any comorbid
> ity"

. 
. label var hypertension_date                                     "Diagnosed hy
> pertension Date"

. label var chronic_respiratory_disease_date      "Other Respiratory Diseases D
> ate"

. label var chronic_cardiac_disease_date          "Other Heart Diseases Date"

. label var diabetes_date                                         "Diabetes Dat
> e"

. label var cancer_haem_date                                      "Haem cancer 
> Date"

. label var cancer_nonhaem_date                           "Non-haem cancer Date
> "

. label var chronic_liver_disease_date            "Chronic liver disease Date"

. label var other_neuro_date              "Neurological disease  Date"

. label var stroke_dementia_date                      "Stroke or dementia date"
>                                                    

. label var ra_sle_psoriasis_date                         "Autoimmune disease  
> Date"

. lab var perm_immunodef_date                             "Permanent immunosupp
> ression date"

. lab var temp_immunodef_date                             "Temporary immunosupp
> ression date"

. label var kidney_transplant_date                                             
>    "Kidney transplant"     

. label var other_transplant_date                                         "Othe
> r solid organ transplant"

. label var asplenia_date                                                 "Aspl
> enia date"

. lab var  bphigh "non-missing indicator of known high blood pressure"

. lab var bpcat "Blood pressure four levels, non-missing"

. lab var htdiag_or_highbp "High blood pressure or hypertension diagnosis"

. lab var shield "Probable shielding"

. 
. * Outcomes and follow-up
. label var enter_date                                    "Date of study entry"

. label var study_end_censor                      "Date of admin censoring for 
> outcomes"

. 
. 
. label var  covid_tpp_prob                               "Failure/censoring in
> dicator for outcome: covid prob case"

. label var  non_covid_death                              "Failure/censoring in
> dicator for outcome: non-covid death"

. label var  covid_death                              "Failure/censoring indica
> tor for outcome: covid death"

. label var  covid_icu                                "Failure/censoring indica
> tor for outcome: covid icu"

. lab var covidadmission                                  "Failure/censoring in
> dicator for outcome: covid SUS admission"

. lab var covid_death_part1                               "Failure/censoring in
> dicator for outcome: covid death part1"

. lab var  positive_SGSS          "Indicator positive covid test"

. lab var  covid_primary_care_codes               "Indicator positive primary c
> are code COVID infection"

. 
. rename died_date_onsnoncovid date_non_covid_death

. rename died_date_onscovid date_covid_death

. rename covid_icu_date date_covid_icu

. rename covid_admission_primary_date date_covidadmission

. label var date_covid_tpp_prob                   "Date of probable COVID-19 cl
> inical infection"

. label var date_non_covid_death                  "Date of ONS non-COVID-19 Dea
> th"

. label var  date_covid_death                     "Date of ONS COVID-19 Death"

. lab var date_covid_icu                                  "Date of admission to
>  ICU for COVID-19" 

. lab var date_covidadmission                     "Date of admission to hospita
> l for COVID-19" 

. label var  died_date_onscovid_part1                     "Date of ONS COVID De
> ath part1"

. lab var  date_positive_SGSS             "Date of positive SGSS test"

. lab var   date_covid_primary_care_codes "Date of COVID-19 primary care code"

. * Survival times
. label var  stime_covid_tpp_prob                         "Survival tme (date);
>  outcome "

. label var  stime_non_covid_death                        "Survival tme (date);
>  outcome non_covid_death   "

. label var  stime_covid_death                            "Survival time (date)
> ; outcome covid death"

. label var  stime_covid_icu                                      "Survival tim
> e (date); outcome covid icu"

. label var  stime_covidadmission                         "Survival time (date)
> ; outcome covid hosp admission"

. label var  stime_covid_death_part1                              "Survival tim
> e (date); outcome covid death part1"

. 
. *Key DATES
. label var   died_date_ons                               "Date death ONS"

. label var  has_12_m_follow_up                   "Has 12 months follow-up"

. lab var  dereg_date                                             "Date deregis
> tration from practice"

. 
. 
. 
. 
. /* TIDY DATA=================================================================
> =*/
. *  Drop variables that are not needed (those not labelled)
. ds, not(varlabel)
died_ons_c~y  bp_dias       diabetes_e~s  esrf          bmi_age
died_ons_c~g  bp_dias_da~e  diabetes_e~r  dialysis_d~e  SCr_adj
sex           bp_dias_da~d  hba1c_mmol~l  dialysis      min
ethnicity_~e  creatinine    hba1c_mmol~e  asthmacat     max
care_home_~e  crea~te_date  hba1c_per~ge  diabetes      hba1c_pct
bmi_measured  crea~ne_date  hba1c_per~te  covid_admi~e  dm_type
bp_sys        smoki~e_date  cancer_haem   age_drop      dm_type_ex~s
bp_sys_dat~e  smoki~s_date  cancer_non~m  nokids        hba1ccat
bp_sys_dat~d  diabetes_t~e  esrf_date     bmi_time      hba1c75

. drop `r(varlist)'

. drop covid_admission_primary_diagnosi   

. 
.         
. 
. /* APPLY INCLUSION/EXCLUIONS=================================================
> =*/ 
. 
. *************TEMP DROP TO INVESTIGATE ASSOCIATIONS MORE EASILY***************
> ***
. noi di "DROP AGE >110:"
DROP AGE >110:

. drop if age > 110 & age != .
(12 observations deleted)

. count
  15,816,589

. 
. noi di "DROP IF DIED BEFORE INDEX"
DROP IF DIED BEFORE INDEX

. drop if died_date_ons <=enter_date
(356 observations deleted)

. count
  15,816,233

. 
. noi di "DROP IF COVID IN TPP BEFORE INDEX"
DROP IF COVID IN TPP BEFORE INDEX

. drop if date_covid_tpp_prob <=enter_date
(388 observations deleted)

. count
  15,815,845

. 
. noi di "DROP IMD MISSING"
DROP IMD MISSING

. recode imd .=9
(imd: 0 changes made)

. recode imd .u=9
(imd: 165213 changes made)

. drop if imd==9
(165,213 observations deleted)

. count
  15,650,632

. 
. noi di "DROP MISSING GENDER:"
DROP MISSING GENDER:

. recode male .=9
(male: 289 changes made)

. recode male .u=9
(male: 0 changes made)

. drop if male==9
(289 observations deleted)

. count   
  15,650,343

.         
. ***************
. *  Save data  *
. ***************
. sort patient_id

. save $tempdir/analysis_dataset_with_missing_ethnicity`dataset', replace
(note: file tempdata/analysis_dataset_with_missing_ethnicityMAIN.dta not found)
file tempdata/analysis_dataset_with_missing_ethnicityMAIN.dta saved

. 
. noi di "DROP NO ETHNICITY DATA"
DROP NO ETHNICITY DATA

. keep if ethnicity!=.u   
(3,631,427 observations deleted)

. 
. save $tempdir/analysis_dataset`dataset', replace
(note: file tempdata/analysis_datasetMAIN.dta not found)
file tempdata/analysis_datasetMAIN.dta saved

. 
. 
. 
. use  $tempdir/analysis_dataset`dataset', clear

. keep if age<=65
(2,684,524 observations deleted)

. * Create restricted cubic splines for age
. mkspline age = age, cubic nknots(4)

. save $tempdir/analysis_dataset_ageband_0`dataset', replace
(note: file tempdata/analysis_dataset_ageband_0MAIN.dta not found)
file tempdata/analysis_dataset_ageband_0MAIN.dta saved

. 
. 
. use  $tempdir/analysis_dataset`dataset', clear

. keep if age>65
(9,334,392 observations deleted)

. * Create restricted cubic splines for age
. mkspline age = age, cubic nknots(4)

. save $tempdir/analysis_dataset_ageband_1`dataset', replace
(note: file tempdata/analysis_dataset_ageband_1MAIN.dta not found)
file tempdata/analysis_dataset_ageband_1MAIN.dta saved

. 
. 
. 
. forvalues x=0/1 {
  2. 
. use $tempdir/analysis_dataset_ageband_`x'`dataset', clear
  3. * Save a version set on NON ONS covid death outcome
. stset stime_non_covid_death, fail(non_covid_death)                           
>    ///
>         id(patient_id) enter(enter_date) origin(enter_date)
  4. /*WEIGHTING - TO REDUCE TIME 
> set seed 30459820
> keep if _d==1|uniform()<.03
> gen pw = 1
> replace pw = (1/0.03) if _d==0
> stset stime_non_covid_death [pweight = pw],  fail(non_covid_death)           
>                    ///
>         id(patient_id) enter(enter_date) origin(enter_date)*/
. save "$tempdir/cr_create_analysis_dataset_STSET_non_covid_death_ageband_`x'`d
> ataset'.dta", replace
  5.         
. /*no longer using composite outcome
> use $tempdir/analysis_dataset_ageband_`x'`dataset', clear
> * Save a version set on covid death/icu  outcome
> stset stime_covid_death_icu, fail(covid_death_icu)                           
>    ///
>         id(patient_id) enter(enter_date) origin(enter_date)
> save "$tempdir/cr_create_analysis_dataset_STSET_covid_death_icu_ageband_`x'`d
> ataset'.dta", replace
> */
. use $tempdir/analysis_dataset_ageband_`x'`dataset', clear
  6. * Save a version set on covid icu  outcome only
. stset stime_covid_icu, fail(covid_icu)                          ///
>         id(patient_id) enter(enter_date) origin(enter_date)
  7. save "$tempdir/cr_create_analysis_dataset_STSET_covid_icu_ageband_`x'`data
> set'.dta", replace
  8. 
. use $tempdir/analysis_dataset_ageband_`x'`dataset', clear
  9. * Save a version set on covid death only
. stset stime_covid_death, fail(covid_death)                              ///
>         id(patient_id) enter(enter_date) origin(enter_date)
 10. save "$tempdir/cr_create_analysis_dataset_STSET_covid_death_ageband_`x'`da
> taset'.dta", replace
 11. 
. /*this was created for investigation only
> use $tempdir/analysis_dataset_ageband_`x'`dataset', clear
> * Save a version set on covid death only
> stset stime_covid_death_part1, fail(covid_death_part1)                       
>    ///
>         id(patient_id) enter(enter_date) origin(enter_date)
> save "$tempdir/cr_create_analysis_dataset_STSET_covid_death_part1_ageband_`x'
> `dataset'.dta", replace
> */
. use $tempdir/analysis_dataset_ageband_`x'`dataset', clear
 12. * Save a version set on probable covid
. stset stime_covid_tpp_prob, fail(covid_tpp_prob)                             
>    ///
>         id(patient_id) enter(enter_date) origin(enter_date)
 13. save "$tempdir/cr_create_analysis_dataset_STSET_covid_tpp_prob_ageband_`x'
> `dataset'.dta", replace       
 14. 
. use $tempdir/analysis_dataset_ageband_`x'`dataset', clear
 15. * Save a version set on hosp admission for covid
. stset stime_covidadmission, fail(covidadmission)                             
>    ///
>         id(patient_id) enter(enter_date) origin(enter_date)
 16. save "$tempdir/cr_create_analysis_dataset_STSET_covidadmission_ageband_`x'
> `dataset'.dta", replace       
 17. 
. }

                id:  patient_id
     failure event:  non_covid_death != 0 & non_covid_death < .
obs. time interval:  (stime_non_covid_death[_n-1], stime_non_covid_death]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  9,334,392  total observations
          0  exclusions
------------------------------------------------------------------------------
  9,334,392  observations remaining, representing
  9,334,392  subjects
     10,580  failures in single-failure-per-subject data
 1.9638e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_non_covid_death_ageband_0
> MAIN.dta not found)
file tempdata/cr_create_analysis_dataset_STSET_non_covid_death_ageband_0MAIN.dt
> a saved

                id:  patient_id
     failure event:  covid_icu != 0 & covid_icu < .
obs. time interval:  (stime_covid_icu[_n-1], stime_covid_icu]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  9,334,392  total observations
          0  exclusions
------------------------------------------------------------------------------
  9,334,392  observations remaining, representing
  9,334,392  subjects
      1,601  failures in single-failure-per-subject data
 1.9636e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covid_icu_ageband_0MAIN.d
> ta not found)
file tempdata/cr_create_analysis_dataset_STSET_covid_icu_ageband_0MAIN.dta save
> d

                id:  patient_id
     failure event:  covid_death != 0 & covid_death < .
obs. time interval:  (stime_covid_death[_n-1], stime_covid_death]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  9,334,392  total observations
          0  exclusions
------------------------------------------------------------------------------
  9,334,392  observations remaining, representing
  9,334,392  subjects
      1,219  failures in single-failure-per-subject data
 1.9638e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covid_death_ageband_0MAIN
> .dta not found)
file tempdata/cr_create_analysis_dataset_STSET_covid_death_ageband_0MAIN.dta sa
> ved

                id:  patient_id
     failure event:  covid_tpp_prob != 0 & covid_tpp_prob < .
obs. time interval:  (stime_covid_tpp_prob[_n-1], stime_covid_tpp_prob]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  9,334,392  total observations
          0  exclusions
------------------------------------------------------------------------------
  9,334,392  observations remaining, representing
  9,334,392  subjects
     51,560  failures in single-failure-per-subject data
 1.9587e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covid_tpp_prob_ageband_0M
> AIN.dta not found)
file tempdata/cr_create_analysis_dataset_STSET_covid_tpp_prob_ageband_0MAIN.dta
>  saved

                id:  patient_id
     failure event:  covidadmission != 0 & covidadmission < .
obs. time interval:  (stime_covidadmission[_n-1], stime_covidadmission]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  9,334,392  total observations
          0  exclusions
------------------------------------------------------------------------------
  9,334,392  observations remaining, representing
  9,334,392  subjects
      6,374  failures in single-failure-per-subject data
 1.9630e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covidadmission_ageband_0M
> AIN.dta not found)
file tempdata/cr_create_analysis_dataset_STSET_covidadmission_ageband_0MAIN.dta
>  saved

                id:  patient_id
     failure event:  non_covid_death != 0 & non_covid_death < .
obs. time interval:  (stime_non_covid_death[_n-1], stime_non_covid_death]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  2,684,524  total observations
          0  exclusions
------------------------------------------------------------------------------
  2,684,524  observations remaining, representing
  2,684,524  subjects
     45,940  failures in single-failure-per-subject data
  561790738  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_non_covid_death_ageband_1
> MAIN.dta not found)
file tempdata/cr_create_analysis_dataset_STSET_non_covid_death_ageband_1MAIN.dt
> a saved

                id:  patient_id
     failure event:  covid_icu != 0 & covid_icu < .
obs. time interval:  (stime_covid_icu[_n-1], stime_covid_icu]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  2,684,524  total observations
          0  exclusions
------------------------------------------------------------------------------
  2,684,524  observations remaining, representing
  2,684,524  subjects
        732  failures in single-failure-per-subject data
  561746760  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covid_icu_ageband_1MAIN.d
> ta not found)
file tempdata/cr_create_analysis_dataset_STSET_covid_icu_ageband_1MAIN.dta save
> d

                id:  patient_id
     failure event:  covid_death != 0 & covid_death < .
obs. time interval:  (stime_covid_death[_n-1], stime_covid_death]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  2,684,524  total observations
          0  exclusions
------------------------------------------------------------------------------
  2,684,524  observations remaining, representing
  2,684,524  subjects
      6,507  failures in single-failure-per-subject data
  561790738  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covid_death_ageband_1MAIN
> .dta not found)
file tempdata/cr_create_analysis_dataset_STSET_covid_death_ageband_1MAIN.dta sa
> ved

                id:  patient_id
     failure event:  covid_tpp_prob != 0 & covid_tpp_prob < .
obs. time interval:  (stime_covid_tpp_prob[_n-1], stime_covid_tpp_prob]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  2,684,524  total observations
          0  exclusions
------------------------------------------------------------------------------
  2,684,524  observations remaining, representing
  2,684,524  subjects
     18,893  failures in single-failure-per-subject data
  560314456  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covid_tpp_prob_ageband_1M
> AIN.dta not found)
file tempdata/cr_create_analysis_dataset_STSET_covid_tpp_prob_ageband_1MAIN.dta
>  saved

                id:  patient_id
     failure event:  covidadmission != 0 & covidadmission < .
obs. time interval:  (stime_covidadmission[_n-1], stime_covidadmission]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  2,684,524  total observations
          0  exclusions
------------------------------------------------------------------------------
  2,684,524  observations remaining, representing
  2,684,524  subjects
      8,560  failures in single-failure-per-subject data
  561156909  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       212
(note: file tempdata/cr_create_analysis_dataset_STSET_covidadmission_ageband_1M
> AIN.dta not found)
file tempdata/cr_create_analysis_dataset_STSET_covidadmission_ageband_1MAIN.dta
>  saved

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  /workspace/log/01_cr_analysis_dataset.log
  log type:  text
 closed on:  23 Jan 2021, 01:41:00
-------------------------------------------------------------------------------
